his.updateTelemetryContext(f),(f===null||f===void 0?void 0:f.userAadId)&&(t===null||t===void 0?void 0:t.RoutingHint)&&this.trySendValueEvents(r,t.RoutingHint,{name:"LogAadUserId",value:u}),e){this.setMsbAccount(t);const f=this.tokenChanged,r=()=>{this.handleMsbTokenChanged(),i===null||i===void 0?void 0:i(t,f)},e=()=>{r()},o=n=>{(n===null||n===void 0?void 0:n.hasTokenIssue)&&(this.msbAccount=undefined,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined)),r()};this.msbAccountAvailableTenantSettingHandler?n.safeExecute(()=>this.msbAccountAvailableTenantSettingHandler(e,o,u,this.msbAccount),"MsbTokenManager::msbAccountAvailableTenantSettingHandler"):r()}else this.setMsbAccount(undefined),n.msbHost.tenantManager.setTenantMsbDisabledStatus(),i===null||i===void 0?void 0:i(undefined,!1)}handleSubstrateAccount(n){const t=n===null||n===void 0?void 0:n.Token;t&&this.setSubstrateAccount(n)}fetchMsb3sAccount(t,i){const u=this.getMsbToken("fetchMsb3sAccount");u||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token No Msb Token"),i());const e=n.msbHost.urlUtils.getMsbUrl("v3/user/token/Substrate"),r=BingAtWork.context.conversationId,o=`${e}?cvid=${r}`,s={url:o,checkServerTime:!0,onSuccess:u=>{const e=this.makeAccountInfo(u,f);if(e)t(e);else{const t=`[MSB.Error] fetching 3S token returns no token. response=${JSON.stringify(u)}`;const f=n.msbHost.isMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:f,cvid:r});i()}},onError:(t,u)=>{if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const{responseText:s,message:i,stackTrace:f,serverTraceId:e,requestSentTime:h,responseReceivedTime:c,isBrowserOnline:l,hResultString:a}=u,o=`[MSB.Error] fetching 3S token has error, details=${JSON.stringify({statusCode:t,responseText:s,message:i,stackTrace:f,serverTraceId:e})}`;const v=n.msbHost.isMsbInternalTenant()?o:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch 3S Token Failed",i,{stackTrace:f,serverTraceId:e,additionalMessage:v,statusCode:t,cvid:r},{Online:l,HResult:a,ReqTS:h,ResTS:c})}i()}};n.Msb.sendAjax(s)}makeAccountInfo(t,i){var r,u,f;if(!(t===null||t===void 0?void 0:t.token)||!(t===null||t===void 0?void 0:t.tokenExpiry)||!((r=t===null||t===void 0?void 0:t.tenant)===null||r===void 0?void 0:r.id)||!((u=t===null||t===void 0?void 0:t.user)===null||u===void 0?void 0:u.id)||!((f=t===null||t===void 0?void 0:t.user)===null||f===void 0?void 0:f.displayName))return undefined;const{token:s,tokenExpiry:h,tenant:{id:e},user:{id:o,displayName:c}}=t;return{Token:s,ExpireDateTime:h-i,UserName:c,RoutingHint:`OID:${e}:${o}`,LastUpdated:n.getCurrentDate().getTime(),TenantId:e,UserObjectId:o}}setMsbAccount(t){var r,u,f;const e=(r=this.msbAccount)===null||r===void 0?void 0:r.Token,i=t===null||t===void 0?void 0:t.Token;if(this.msbAccount=t,!!i&&e!=i){if(this.tokenChanged=!0,BingAtWork.wsb){BingAtWork.wsb.wsbAccessToken=i;const e=t.ExpireDateTime;BingAtWork.wsb.wsbAccessTokenWamExp=e;const o=n.parseJwt(i),r=Number(o===null||o===void 0?void 0:o.exp)*1e3;if(!r){const t=`typeof(parsedToken)=${typeof o}, typeof(jwtExp)=${typeof r}`,i=n.msbHost.isMsbInternalTenant()?`account=${JSON.stringify(this.msbAccount)}`:undefined;bfbWsbTel.logError("Wsb WAM-JWT expiry no value",t,{additionalMessage:i})}BingAtWork.wsb.wsbAccessTokenJwtExp=r;BingAtWork.wsb.wsbAccessTokenRefreshTime=n.getCurrentTime();const s=r-e;s<0&&bfbWsbTel.logError("Wsb WAM-JWT expiry mismatch",`RefreshTime=${BingAtWork.wsb.wsbAccessTokenRefreshTime} WamExp=${e}, JwtExp=${r}`);BingAtWork.wsb.gccRegion=n.getGccRegionFromToken(i);!this.initialMsbApiEnv&&((u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.context)===null||u===void 0?void 0:u.msbApiEnv)&&(this.initialMsbApiEnv=BingAtWork.context.msbApiEnv);this.initialMsbApiEnv&&(BingAtWork.context.msbApiEnv=(f=n.msbHost.urlUtils.mapGccRegionToMsbApiEnv(BingAtWork.wsb.gccRegion))!==null&&f!==void 0?f:this.initialMsbApiEnv)}if(this.msbAccount){const n=this.getTokenExpiry(i,this.msbAccount.ExpireDateTime);n&&this.msbAccount.ExpireDateTime<n&&(this.msbAccount.ExpireDateTime=n)}}}setSubstrateAccount(n){this.substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)}getChatFeatureParams(){const t=[];if(n.config.msbForceBizChatEligibilityCheck&&t.push("bfbwsbchatmt"),t.length>0){const n=t.join(",");return`setflight=${n}&features=${n}`}return""}sendMsbProactiveSignIn(t){var r;const u={["Content-Type"]:"text/plain"},f={Authentication:t};let i=n.msbHost.urlUtils.getMsbUrl("v3/user/proactive/signin");if(n.config.msbEnableChat){const t=this.getChatFeatureParams(),e=(r=this.msbAccount)===null||r===void 0?void 0:r.RoutingHint;i=t?n.msbHost.urlUtils.insertParameter(i,t):i;n.fetchUrl(i,u,JSON.stringify(f),n=>{if((n===null||n===void 0?void 0:n.status)===200)try{const t=JSON.parse(n.responseText);this.setChatEligibilityCache(t===null||t===void 0?void 0:t.chatEligibilityType,e)}catch(t){}},undefined,undefined,!0,undefined,!0)}else n.fetchUrl(i,u,JSON.stringify(f),undefined,undefined,undefined,!0,undefined,!0)}setChatEligibilityCache(i,r){r&&i?(this.accountChatEligibility={routingHint:r,eligibility:i},n.LightweightStorage.setItem(t,JSON.stringify(this.accountChatEligibility))):(this.accountChatEligibility=undefined,n.LightweightStorage.removeItem(t))}getChatEligibility(){var n,t,i;return((n=this.accountChatEligibility)===null||n===void 0?void 0:n.routingHint)&&this.accountChatEligibility.routingHint===((t=this.msbAccount)===null||t===void 0?void 0:t.RoutingHint)?(i=this.accountChatEligibility.eligibility)!==null&&i!==void 0?i:"None":"None"}loadChatEligibilityCache(){const i=n.LightweightStorage.getItem(t);if(i)try{this.accountChatEligibility=JSON.parse(i)}catch(r){this.accountChatEligibility=undefined}}handleMsbTokenChanged(){if(this.tokenChanged&&n.msbHost.isTenantMsbEnabled()){this.tokenChanged=!1;const t=this.getMsbToken();t&&(n.msbHost.isGccHighTenant()||this.sendMsbProactiveSignIn(t),this.tokenChangedHandlers&&this.tokenChangedHandlers.forEach(i=>{n.safeExecute(()=>i(t),"MsbTokenManager::fireTokenChanged")}))}}handleWsbAccessTokenAvailable(t){t==1&&(this.accountTypeChangedIsFiring||this.callGetMsbAccount(!1,(t,i)=>{this.notifyWsbAadReady(t),!i||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)||(n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0))},"WsbAccessTokenAvailable"))}handleAccountTypeChanged(){this.accountTypeChangedIsFiring=!0;const t=t=>{this.callGetMsbAccount(!0,t=>{this.notifyWsbAadReady(t),this.accountTypeChangedIsFiring=!1,n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0)},t)};n.config.msbMockToken?this.getMockToken(()=>{t("AccountTypesChanged_withMockToken")}):t("AccountTypesChanged")}handleWsbSelectedAccountChanged(){this.msbAccount=undefined;this.substrateAccount=undefined;this.lokiAccount=undefined;this.userId=undefined;this.tenantId=undefined}handleWsbVerifyAccountRequired(n,t){let r;switch(n){case 1:r="AAD";break;case 0:r="MSA";break;default:r="Unknown"}if(r!="MSA"){let i;switch(t){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":i="BingAtWork";break;case"https://www.bing.com":i="Bing";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":i="PeopleCard";break;case"https://outlook.office.com/":i="ProfilePictureApi";break;case"https://substrate.office.com":i="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":i="Cortana";break;case"LiveProfileCard.Access":i="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":case"https://outlook.office.com/M365.Access":i="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":case"https://substrate.office.com/M365.Access":i="SubstrateConsumer";break;default:i="Unknown"}const f=`${r}@${i}`;this.trySendValueEvents(u,f,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:r,resourceOrScope:i}})}}setAadUserInfo(n){this.aadUserInfo=n}getAadUserInfo(){return this.aadUserInfo}createAadUserInfo(n){var t,i,r,u;return n?{tenantId:(t=n.TenantId)!==null&&t!==void 0?t:"",tenantName:(i=n.TenantName)!==null&&i!==void 0?i:"",userAadId:(r=n.UserObjectId)!==null&&r!==void 0?r:"",email:n.UserName,userFirstName:(u=n.UserFirstName)!==null&&u!==void 0?u:""}:undefined}updateTelemetryContext(t){var i,r;this.userId=t===null||t===void 0?void 0:t.userAadId;this.tenantId=t===null||t===void 0?void 0:t.tenantId;_w.bfbWsbTel&&bfbWsbTel.setUid((i=this.userId)!==null&&i!==void 0?i:"");_w.bfbWsbTel&&bfbWsbTel.setTenantId((r=this.tenantId)!==null&&r!==void 0?r:"");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(this.tenantId)}clearUserTenantContext(){_w.bfbWsbTel&&bfbWsbTel.setUid("");_w.bfbWsbTel&&bfbWsbTel.setTenantId("");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(undefined)}isThrottledLogInfoExpired(t,i){const u=n.LightweightStorage.getItem(i),r=this.parseCachedLogInfo(u);if(r==null||r.LogKey!=t)return!0;const f=n.config.msbLogThrottlingTimeInHours*36e5;return n.getCurrentTime()>r.SavedTimestamp+f?!0:!1}parseCachedLogInfo(n){const t=n===null||n===void 0?void 0:n.split(";");return!t||t.length!=2?undefined:{LogKey:t[1],SavedTimestamp:+t[0]}}trySendValueEvents(t,i,r){if(this.isThrottledLogInfoExpired(i,t)){_w.bfbWsbTel&&r&&bfbWsbTel.logValue(r.name,r.value,r.kv);const u=`${n.getCurrentTime()};${i}`;n.Ligh